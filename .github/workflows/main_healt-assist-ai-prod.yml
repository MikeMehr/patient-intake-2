# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
name: Build and deploy Node.js app to Azure Web App - healt-assist-ai-prod

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Security audit (runtime dependencies)
        run: npm run audit:prod

      - name: Build
        run: npx next build --webpack

      - name: Create deploy bundle (Next standalone)
        run: |
          rm -rf deploy
          mkdir -p deploy

          # Copy the standalone server + minimal node_modules produced by Next.
          # Use `/.` so we include hidden paths like `.next/standalone/.next`.
          cp -R .next/standalone/. deploy/

          # Next serves static assets from `.next/static` at runtime.
          mkdir -p deploy/.next
          mkdir -p deploy/.next/static
          mkdir -p deploy/.next/server
          cp -R .next/static/. deploy/.next/static/
          cp -R .next/server/. deploy/.next/server/
          cp .next/BUILD_ID deploy/.next/BUILD_ID

          # Ensure runtime node_modules matches the build exactly.
          # Some App Service instances may keep stale extracted modules between deploys.
          mkdir -p deploy/node_modules
          cp -R node_modules/. deploy/node_modules/

          # Public assets (e.g. images) still need to be present.
          if [ -d "public" ]; then
            cp -R public deploy/public
          fi

          # Ensure App Service's default `npm start` works for this bundle.
          cat > deploy/package.json <<'EOF'
          {
            "name": "patient-intake-2",
            "private": true,
            "scripts": {
              "start": "node server.js"
            }
          }
          EOF

          # Zip the bundle so the deployed root is correct (prevents nesting under `deploy/`).
          rm -f deploy.zip
          (cd deploy && zip -qr ../deploy.zip .)

          echo "Deploy bundle contents:"
          ls -la deploy

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: deploy.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: .

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_6020A719440E4144A530B2C41F8D256A }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_15A4C1D32CB74B68B88418B1E44EEC12 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_BBD0350A7C5B42A088F68806AAD1097B }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: healt-assist-ai-prod
          slot-name: Production
          package: deploy.zip
          clean: true
          restart: true
